<div class="chat-show-page mt-5" data-controller="chat-message">
  <br>
  <div class="container">
    <!-- Flash Messages -->
    <% if flash[:alert] || flash[:notice] %>
      <div class="row">
        <div class="col-12">
          <% if flash[:alert] %>
            <div class="alert alert-warning alert-dismissible fade show m-2" role="alert">
              <%= flash[:alert] %>
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          <% end %>
          <% if flash[:notice] %>
            <div class="alert alert-info alert-dismissible fade show m-2" role="alert">
              <%= flash[:notice] %>
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <div class="row justify-content-center">

      <!-- Main Chat Area -->
      <div class="col-12 col-xl-10 chat-main">
        <div class="chat-header d-flex align-items-center mb-3">
          <%= link_to chats_path, class: "btn btn-link me-2", title: "Back to All Chats" do %>
            <i class="fas fa-arrow-left"></i>
          <% end %>
          <%= image_tag "icons/favicon-96x96.png", class: "chat-avatar-header rounded-circle", alt: "Hopps" %>
          <div class="ms-3 flex-grow-1">
            <h5 class="mb-0"><%= @chat.title.present? ? @chat.title : "Hopps" %></h5>
            <% if @chat.appointment.present? %>
              <small class="text-muted d-block">
                <i class="fas fa-calendar me-1"></i>
                <%= @chat.appointment.salon %> - <%= @chat.appointment.time.strftime("%b %d, %Y at %I:%M %p") if @chat.appointment.time.present? %>
              </small>
              <%= link_to appointment_path(@chat.appointment), class: "badge bg-primary text-decoration-none mt-1", target: "_blank" do %>
                <i class="fas fa-external-link-alt me-1"></i> View Appointment
              <% end %>
            <% else %>
              <small class="text-muted">Online â€¢ Ready to help</small>
            <% end %>
          </div>
          <%= link_to new_chat_path, class: "btn btn-outline-primary btn-sm ms-auto" do %>
            <i class="fas fa-plus"></i> New Chat
          <% end %>
        </div>

        <div class="message-messages" id="messagesContainer" data-chat-message-target="messagesContainer">
          <% if @chat.messages.any? %>
            <% @chat.messages.each do |message| %>
              <% if message.role == 'user' %>
                <div class="message-wrapper user-message">
                  <div class="message-bubble">
                    <strong>You</strong>
                    <% if message.content.present? %>
                      <div class="mb-0"><%= markdown_to_html(message.content).html_safe %></div>
                    <% end %>
                    <% if message.photos.attached? %>
                      <div class="message-images mt-2">
                        <% message.photos.each do |photo| %>
                          <%= link_to photo.url, target: "_blank" do %>
                            <%= image_tag photo, class: "message-image", style: "max-width: 300px; max-height: 300px; border-radius: 8px; display: block; margin-bottom: 0.5rem;" %>
                          <% end %>
                        <% end %>
                      </div>
                    <% end %>
                  </div>
                  <% if current_user.avatar.attached? %>
                    <%= image_tag current_user.avatar, class: "customer-avatar rounded-circle" %>
                  <% else %>
                    <%= image_tag "profile.png", class: "customer-avatar rounded-circle", alt: "User" %>
                  <% end %>
                </div>
              <% else %>
                <div class="message-wrapper assistant-message">
                  <%= image_tag "icons/favicon-96x96.png", class: "assistant-avatar rounded-circle", alt: "Hopps" %>
                  <div class="message-bubble">
                    <strong>Hopps</strong>
                    <div class="mb-0"><%= markdown_to_html(message.content).html_safe %></div>
                  </div>
                </div>
              <% end %>
            <% end %>
          <% else %>
            <div class="empty-state">
              <div class="empty-state-icon">
                <i class="fas fa-comments fa-4x"></i>
              </div>
              <h3>Start a conversation</h3>
              <p>Send a message or upload an image to begin</p>
              <div class="quick-suggestions mt-4">
                <button type="button" class="btn btn-outline-primary me-2 mb-2"
                        data-action="click->chat-message#insertSuggestion"
                        data-chat-message-text="Help me find a stylist for curly hair">
                  <i class="fas fa-magic me-1"></i> Curly hair stylist
                </button>
                <button type="button" class="btn btn-outline-primary me-2 mb-2"
                        data-action="click->chat-message#insertSuggestion"
                        data-chat-message-text="Book an appointment for a haircut">
                  <i class="fas fa-cut me-1"></i> Book a haircut
                </button>
                <button type="button" class="btn btn-outline-primary me-2 mb-2"
                        data-action="click->chat-message#insertSuggestion"
                        data-chat-message-text="Hair colour consultation">
                  <i class="fas fa-palette me-1"></i> Colour consultation
                </button>
              </div>
            </div>
          <% end %>
        </div>

        <!-- Message Input -->
        <div class="message-input-container mt-3" data-controller="image-upload">
          <%= simple_form_for [@chat, @message], html: { multipart: true, class: "message-input-form", id: "messageForm", data: { chat_message_target: "form", action: "turbo:submit-end->chat-message#scrollToBottom" } } do |f| %>
            <div class="input-wrapper d-flex align-items-center gap-2" data-image-upload-target="area">
              <label for="messagePhoto" class="btn btn-link upload-btn" data-action="click->image-upload#openFileDialog">
                <i class="fas fa-image"></i>
              </label>
              <%= f.input :photos, as: :file, input_html: { multiple: true, accept: "image/*", class: "d-none", id: "messagePhoto", data: { image_upload_target: "input", action: "change->image-upload#handleFileSelect" } }, label: false, wrapper: false %>
              <%= f.input :content, as: :text, input_html: { class: "form-control message-input flex-grow-1", placeholder: "Type your message...", rows: 1, id: "messageTextarea", data: { chat_message_target: "textarea", action: "input->chat-message#handleInput keydown->chat-message#handleKeydown" } }, label: false, wrapper: false %>
              <button type="submit" class="btn btn-primary send-btn">
                <i class="fas fa-paper-plane"></i>
              </button>
            </div>

            <div class="image-preview d-none" id="imagePreview" data-image-upload-target="previewContainer">
              <img src="" alt="Preview" id="previewImg" data-image-upload-target="previewImage">
              <button type="button" class="btn btn-sm btn-danger remove-image" id="removeImage" data-image-upload-target="removeButton" data-action="click->image-upload#removePreview">
                <i class="fas fa-times"></i>
              </button>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>
