<div class="chat-index-page">
  <div class="container mt-4">
    Chat with Hopps
    <div class="text-center mb4">
      <h1>New Chat</h1>
      <p class="text-muted">Need help finding the perfect stylist and appointments, chat with Hopper</p>
    </div>

    <div class="row justify-content-center mb-4">
      <div class="col-lg-10 col-xl-8">
        <div class="upload-section">
          <h4>Upload you hair inspo</h4>
          <p class="text-muted mb-3">Share a picture and let Hopps help you find you a stylist</p>

          <%= form_with url: chats_path, method: :post, multipat: true, Local: true, class: "upload-form" do |f| %>
          <div class="upload-area" id="uploadArea">
            <div class="upload-icon">
              <i class="fas fa-image"></i>
            </div>
            <p class="upload-text">Click to upload or drag and drop</p>
            <p class="upload-subtext">PNG, JPG, JPEG up to 20mb</p>

            <%= f.file_field :photo, accept: "image/*", class: "upload-input", id: "photoInput" %>


            <div class="preview-container d-none" id="previewContainer">
              <img src="" alt="Preview" id="previewImage" class="preiew-image">
              <button type="button" class="btn btn-sm btn-danger remove-preview" id="removePreview">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>

          <div class="mt-3">
            <%= f.text_area :content, class: "form-control", placeholder: "Describe what you're looking for or ask a question...", rows: 3%>
          </div>

          <div class="mt-3 text-center">
            <%= f.submit "Chat with Hopper", class: "btn btn-primary px-4" %>
          </div>
        <% end %>
      </div>

      <div class="quick-start-section mt-4">
        <h5 class="text-center mb-3">Or try one of these to get the conversation going:</h5>
          <div class="row g-3">
            <div class="col-md-6">
              <%= link_to chats_path(prompt: "Help me find a stylist for curly hair"), method: :post, class: "quick-start-card" do %>
                <i class="fas fa-user-tie mb-2"></i>
                <p class="mb-0">Find a stylist for curly hair</p>
              <% end %>
            </div>
            <div class="col-md-6">
              <%= link_to chats_path(prompt: "Book an appointment for a haircut"), method: :post, class: "quick-start-card" do %>
                <i class="fas fa-user-tie mb-2"></i>
                <p class="mb-0">Book a haircut</p>
              <% end %>
            </div>
            <div class="col-md-6">
              <%= link_to chats_path(prompt: "Hair colour consultation"), method: :post, class: "quick-start-card" do %>
                <i class="fas fa-user-tie mb-2"></i>
                <p class="mb-0">Hair colour consultation</p>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <% if @chat.present? %>
      <%= turbo_stream_from @chat %>

      <div class="d-flex justify-content-between mb-2">
        <%= link_to "â† Back to Chats", chats_path %>

        <% if @chat.appointment.present? %>
          /
          <%= link_to "Back to Appointment", appointment_path(@chat.appointment) %>
        <% end %>
      </div>

      <% if Rails.env.development? %>
        <div class="text-end small text-muted">
          Input tokens: <%= @input_tokens %> /
          Output tokens: <%= @output_tokens %> /
          Context window: <%= @context_window %>
        </div>
      <% end %>

      <hr>

      <h2 id="chat_title"><%= @chat.title %></h2>

      <div id="messages" class="chat-messages">
        <% @chat.messages.visible.each do |message| %>

          <div class="message-wrapper <%= message.role == 'assistant' ? 'assistant-message' : 'user-message' %>">

            <% if message.role == "assistant" %>
              <img
                src="https://images.unsplash.com/photo-1722292373839-fc27dc345ff0?q=80&w=987&auto=format&fit=crop&ixlib=rb-4.1.0"
                class="assistant-avatar"
                alt="Hopps"
              >
            <% end %>

            <div class="message-bubble">
              <strong><%= message.role.capitalize %></strong><br>
              <%= message.content %>

              <% if message.photos.attached? %>
                <% message.photos.each do |photo| %>
                  <div class="mt-2">
                    <%= cl_image_tag photo.key, height: 300, width: 400, crop: :fill %>
                  </div>
                <% end %>
              <% end %>
            </div>

          </div>

        <% end %>
      </div>

      <div id="new_message">
        <%= render "messages/form", chat: @chat, message: @message %>
      </div>
    <% end %>
  </div>
</div>
