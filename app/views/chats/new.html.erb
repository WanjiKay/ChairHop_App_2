<div class="chat-index-page">
  <div class="container mt-4">

    <% if params[:appointment_id].present? %>
      <div class="mb-3">
        <%= link_to appointment_path(params[:appointment_id]), class: "btn btn-outline-primary" do %>
          <i class="fas fa-arrow-left me-2"></i>Back to Appointment
        <% end %>
      </div>
    <% end %>

    Chat with Hopps

    <div class="text-center mb4">
      <h1>New Chat</h1>
      <p class="text-muted">Need help finding the perfect stylist and appointments, chat with Hopps</p>
    </div>

    <div class="row justify-content-center mb-4">
      <div class="col-lg-10 col-xl-8">

        <div class="upload-section">

          <h4>Upload your hair inspo</h4>
          <p class="text-muted mb-3">Share a picture and let Hopps help you find a stylist</p>

          <%= simple_form_for :message,
                url: chats_path,
                method: :post,
                html: { multipart: true, class: "upload-form" },
                local: true do |f| %>
                <%= hidden_field_tag :appointment_id, params[:appointment_id] %>

            <div class="upload-area" id="uploadArea">

              <div class="upload-icon">
                <i class="fas fa-image"></i>
              </div>

              <p class="upload-text">Click to upload or drag and drop</p>
              <p class="upload-subtext">PNG, JPG, JPEG up to 10mb</p>

              <%= f.input :photos,
                          as: :file,
                          input_html: {
                            multiple: true,
                            accept: 'image/*',
                            class: 'upload-input',
                            id: 'chatPhotoInput'
                          },
                          label: false,
                          wrapper: false %>

              <div class="preview-container d-none" id="previewContainer">
                <img src="" alt="Preview" id="previewImage" class="preview-image">
                <button type="button" class="btn btn-sm btn-danger remove-preview" id="removePreview">
                  <i class="fas fa-times"></i>
                </button>
              </div>

            </div>

            <!-- MESSAGE TEXT AREA -->
            <div class="mt-3">
              <%= f.text_area :content,class: "form-control",placeholder: "Describe what you're looking for or ask a question...",rows: 3 %>
            </div>

            <!-- SUBMIT BUTTON -->
            <div class="mt-3 text-center">
              <%= f.submit "Chat with Hopps", class: "btn btn-primary px-4" %>
            </div>

          <% end %>

        </div>

        <!-- QUICK START HOT TOPICS -->
        <div class="quick-start-section mt-4">
          <h5 class="text-center mb-3">Or try one of these to get the conversation going:</h5>

          <div class="row g-3">

            <div class="col-md-6">
              <%= button_to chats_path(prompt: "Help me find a stylist for curly hair", appointment_id: params[:appointment_id]),
                    method: :post,
                    class: "quick-start-card w-100 border-0" do %>
                <i class="fas fa-user-tie mb-2"></i>
                <p class="mb-0">Find a stylist for curly hair</p>
              <% end %>
            </div>

            <div class="col-md-6">
              <%= button_to chats_path(prompt: "Book an appointment for a haircut", appointment_id: params[:appointment_id]),
                    method: :post,
                    class: "quick-start-card w-100 border-0" do %>
                <i class="fas fa-user-tie mb-2"></i>
                <p class="mb-0">Book a haircut</p>
              <% end %>
            </div>

            <div class="col-md-6">
              <%= button_to chats_path(prompt: "Hair colour consultation", appointment_id: params[:appointment_id]),
                    method: :post,
                    class: "quick-start-card w-100 border-0" do %>
                <i class="fas fa-user-tie mb-2"></i>
                <p class="mb-0">Hair colour consultation</p>
              <% end %>
            </div>

          </div>
        </div>

      </div>
    </div>

  </div>
</div>

<script>
document.addEventListener('turbo:load', function() {
  const uploadArea = document.getElementById('uploadArea');
  const fileInput = document.getElementById('chatPhotoInput');
  const previewContainer = document.getElementById('previewContainer');
  const previewImage = document.getElementById('previewImage');
  const removePreview = document.getElementById('removePreview');

  // Click to upload
  if (uploadArea && fileInput) {
    uploadArea.addEventListener('click', function(e) {
      if (e.target !== removePreview && !removePreview.contains(e.target)) {
        fileInput.click();
      }
    });

    // File input change
    fileInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
          previewImage.src = e.target.result;
          previewContainer.classList.remove('d-none');
        };
        reader.readAsDataURL(file);
      }
    });

    // Remove preview
    if (removePreview) {
      removePreview.addEventListener('click', function(e) {
        e.stopPropagation();
        fileInput.value = '';
        previewContainer.classList.add('d-none');
        previewImage.src = '';
      });
    }

    // Drag and drop
    uploadArea.addEventListener('dragover', function(e) {
      e.preventDefault();
      uploadArea.classList.add('drag-over');
    });

    uploadArea.addEventListener('dragleave', function(e) {
      e.preventDefault();
      uploadArea.classList.remove('drag-over');
    });

    uploadArea.addEventListener('drop', function(e) {
      e.preventDefault();
      uploadArea.classList.remove('drag-over');

      const files = e.dataTransfer.files;
      if (files.length > 0 && files[0].type.startsWith('image/')) {
        fileInput.files = files;

        const reader = new FileReader();
        reader.onload = function(e) {
          previewImage.src = e.target.result;
          previewContainer.classList.remove('d-none');
        };
        reader.readAsDataURL(files[0]);
      }
    });
  }
});
</script>
