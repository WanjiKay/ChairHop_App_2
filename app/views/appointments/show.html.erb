<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="appointment-show-page">
        <!-- Header -->
        <div class="text-center mb-5">
          <h1 class="text-primary fw-bold mb-2"><%= @appointment.salon %></h1>
          <p class="text-muted">
            <i class="fas fa-map-marker-alt me-2"></i><%= @appointment.location %>
          </p>
        </div>

        <!-- Stylist Profile Section -->
        <div class="booking-details-card mb-4">
          <div class="text-center">
            <%= link_to stylist_path(@appointment.stylist), class: "text-decoration-none" do %>
              <div class="profile-picture-wrapper mb-3">
                <% if @appointment.stylist.avatar.attached? %>
                  <%= cl_image_tag @appointment.stylist.avatar.key, class: "profile-picture rounded-circle", alt: @appointment.stylist.name, style: "width: 120px; height: 120px; object-fit: cover; border: 4px solid #4A5D4F; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); cursor: pointer;" %>
                <% else %>
                  <%= image_tag "https://via.placeholder.com/120", class: "profile-picture rounded-circle", style: "width: 120px; height: 120px; object-fit: cover; border: 4px solid #4A5D4F; cursor: pointer;" %>
                <% end %>
              </div>
              <h5 class="text-primary fw-bold mb-2">Your Stylist</h5>
              <p class="text-muted mb-3"><%= @appointment.stylist.name %></p>
            <% end %>
            <%= link_to "View Stylist Profile", stylist_path(@appointment.stylist), class: "btn btn-outline-primary btn-sm" %>
          </div>
        </div>

        <!-- Salon Image -->
        <% if @appointment.image.attached? %>
          <div class="salon-image-card mb-4">
            <%= cl_image_tag @appointment.image.key, class: "rounded", alt: @appointment.salon, style: "width: 100%; height: 250px; object-fit: cover; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);" %>
          </div>
        <% end %>

        <!-- Appointment Details -->
        <div class="booking-details-card mb-4">
          <h4 class="text-primary fw-bold mb-3">
            <i class="fas fa-info-circle me-2"></i>Appointment Details
          </h4>

          <div class="detail-row">
            <span class="detail-label"><i class="fas fa-clock me-2"></i>Time:</span>
            <span class="detail-value"><%= @appointment.time.strftime("%b %d, %Y at %I:%M %p") if @appointment.time.present? %></span>
          </div>

          <div class="detail-row">
            <span class="detail-label"><i class="fas fa-align-left me-2"></i>Description:</span>
            <span class="detail-value"><%= @appointment.content %></span>
          </div>
        </div>

        <% services = @appointment.services.split("\n") %>

        <!-- Booked Status or Service Selection -->
        <% if @appointment.booked? || @appointment.completed? %>
          <div class="alert <%= @appointment.completed? ? 'alert-success' : 'alert-warning' %> text-center mb-4">
            <% if @appointment.completed? %>
              <i class="fas fa-check-circle fa-2x mb-3"></i>
              <h5 class="fw-bold">This appointment is completed</h5>
              <p class="mb-3">This appointment has been marked as completed.</p>
            <% else %>
              <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
              <h5 class="fw-bold">This chair is already filled</h5>
              <p class="mb-3">This appointment has been booked by another customer.</p>
            <% end %>

            <% if @appointment.customer == current_user && @appointment.booked? %>
              <%= button_to "Unbook Appointment",
                    appointment_path(@appointment),
                    method: :delete,
                    data: { confirm: "Are you sure you want to unbook this appointment?" },
                    class: "btn btn-danger" %>
            <% end %>

            <%# Stylists can complete anytime, customers only after appointment time %>
            <% if @appointment.booked? && (@appointment.stylist == current_user || (@appointment.customer == current_user && @appointment.time < Time.current)) %>
              <%= button_to "Mark as Completed",
                    complete_appointment_path(@appointment),
                    method: :patch,
                    data: { confirm: "Mark this appointment as completed?" },
                    class: "btn btn-success" %>
            <% end %>
          </div>
        <% else %>
          <%= form_with url: check_in_appointment_path(@appointment), method: :post, data: { turbo: false } do %>
            <!-- Main Service Selection -->
            <div class="booking-details-card mb-4">
              <h4 class="text-primary fw-bold mb-3">
                <i class="fas fa-cut me-2"></i>Select Your Main Service
              </h4>

              <% services.each_with_index do |service, index| %>
                <% radio_id = "selected_service_#{index}" %>
                <div class="form-check service-option mb-3 p-3" style="border: 2px solid #dee2e6; border-radius: 8px; transition: all 0.3s;">
                  <%= radio_button_tag :selected_service, service, false, id: radio_id, class: "form-check-input", required: true %>
                  <%= label_tag radio_id, service, class: "form-check-label ms-2 fw-bold", style: "color: #333333 !important; font-weight: 700 !important;" %>
                </div>
              <% end %>
            </div>

            <!-- Add-On Services -->
            <div class="booking-details-card mb-4">
              <h4 class="text-primary fw-bold mb-3">
                <i class="fas fa-plus-circle me-2"></i>Add-On Services (Optional)
              </h4>
              <p class="text-muted small mb-3">Select any additional services you'd like to add:</p>

              <% @appointment.relevant_add_ons.each_with_index do |add_on, index| %>
                <% checkbox_id = "add_on_#{index}" %>
                <div class="form-check addon-option mb-3 p-3" style="border: 2px solid #dee2e6; border-radius: 8px;">
                  <%= check_box_tag "selected_add_ons[]", add_on, false, id: checkbox_id, class: "form-check-input" %>
                  <%= label_tag checkbox_id, add_on, class: "form-check-label ms-2", style: "color: #333333 !important; font-weight: 600 !important;" %>
                </div>
              <% end %>
            </div>

            <div class="text-center">
              <%= submit_tag "Continue to Check-In", class: "btn btn-primary btn-lg px-5 py-3 fw-bold" %>
            </div>
          <% end %>
        <% end %>

        <!-- Quick Actions Section -->
        <div class="quick-actions-section mt-5">
          <h5 class="text-primary fw-bold text-center mb-3">Quick Actions</h5>
          <div class="row g-3">
            <div class="col-md-6">
              <%= link_to new_chat_path(appointment_id: @appointment.id), class: "action-card" do %>
                <span style="font-size: 2rem;" class="mb-2 d-block">üê∞</span>
                <p class="mb-0 fw-bold">Ask HOPPS for Help</p>
              <% end %>
            </div>
            <div class="col-md-6">
              <%= button_to appointment_conversations_path(@appointment), method: :post, params: { appointment_id: @appointment.id }, class: "action-card w-100 border-0" do %>
                <i class="fas fa-comment-dots fa-2x mb-2"></i>
                <p class="mb-0 fw-bold">Message Stylist</p>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .service-option:hover, .addon-option:hover {
    border-color: #4A5D4F !important;
    background-color: rgba(74, 93, 79, 0.05);
  }

  /* Nuclear override for service option text colors */
  .service-option .form-check-label,
  .service-option label.form-check-label,
  .addon-option .form-check-label,
  .addon-option label.form-check-label {
    color: #333333 !important;
    font-weight: 600 !important;
  }

  .service-option .form-check-label {
    font-weight: 700 !important;
  }
</style>
