<div class="container py-5">
  <div class="row">
    <div class="col-lg-8 mx-auto">
      <!-- Header -->
      <div class="mb-4">
        <h1 class="text-primary fw-bold">Conversation</h1>
        <p class="text-muted">
          <strong>Appointment:</strong> <%= @conversation.appointment.salon %><br>
          <strong>Customer:</strong> <%= @conversation.customer.name %><br>
          <strong>Stylist:</strong> <%= @conversation.stylist.name %><br>
          <strong>Time:</strong> <%= @conversation.appointment.time.strftime("%b %d, %Y at %I:%M %p") if @conversation.appointment.time.present? %>
        </p>
        <div class="d-flex gap-2">
          <%= link_to "Back to Appointment", appointment_path(@conversation.appointment), class: "btn btn-outline-primary" %>
          <% unless @conversation.appointment.booked? %>
            <%= link_to "Book Appointment", appointment_path(@conversation.appointment), class: "btn btn-primary" %>
          <% end %>
        </div>
      </div>

      <!-- Messages -->
<div class="message-messages mb-4">

  <!-- Subscribe to updates -->
  <%= turbo_stream_from "conversation_#{@conversation.id}_messages" %>

  <!-- Initial render of all existing messages -->
  <div id="conversation_messages">
    <% if @conversation.conversation_messages.empty? %>
      <div id="empty_state" class="empty-state">
        <div class="empty-state-icon">
          <i class="fas fa-comments fa-4x"></i>
        </div>
        <h3>No messages yet</h3>
        <p>Start the conversation by sending a message below.</p>
      </div>
    <% else %>
      <% @conversation.conversation_messages.each do |conversation_message| %>
        <%= render "conversation_messages/conversation_message", conversation_message: conversation_message %>
      <% end %>
    <% end %>
  </div>

</div>

      <!-- Message Form -->
      <div class="message-form-section">
        <h5 class="mb-3">Send a Message</h5>
        <div id="new_conversation_message">
          <%= simple_form_for [@conversation, @conversation_message],
              url: conversation_conversation_messages_path(@conversation),
              html: { id: "conversationMessageForm" } do |f| %>
            <%= f.error_notification %>

            <div class="mb-3">
              <%= f.input :content,
                          as: :text,
                          label: false,
                          placeholder: "Type your message here...",
                          input_html: { rows: 4, class: "form-control", id: "conversationTextarea" } %>
            </div>

            <div class="d-flex align-items-center gap-2 mb-3">
              <label for="conversationPhoto" class="btn btn-outline-secondary">
                <i class="fas fa-image me-2"></i>Attach Image
              </label>
              <%= f.input :photos, as: :file, input_html: { accept: "image/*", class: "d-none", id: "conversationPhoto", multiple: true }, label: false, wrapper: false %>
            </div>

            <div class="image-preview d-none" id="conversationImagePreview">
              <img src="" alt="Preview" id="conversationPreviewImg" style="max-width: 200px; max-height: 200px; border-radius: 8px;">
              <button type="button" class="btn btn-sm btn-danger ms-2" id="removeConversationImage">
                <i class="fas fa-times"></i> Remove
              </button>
            </div>

            <%= f.button :submit, "Send Message", class: "btn btn-primary" %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Auto-scroll to bottom when page loads
function scrollToBottom() {
  const messagesContainer = document.querySelector('.message-messages');
  if (messagesContainer) {
    // Get all message wrappers
    const messages = messagesContainer.querySelectorAll('.message-wrapper');
    if (messages.length > 0) {
      // Scroll the last message into view
      const lastMessage = messages[messages.length - 1];
      lastMessage.scrollIntoView({ behavior: 'instant', block: 'end' });
    } else {
      // Fallback to scrollTop if no messages
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
  }
}

// Run on DOMContentLoaded
document.addEventListener('DOMContentLoaded', scrollToBottom);

// Run on full page load (after images)
window.addEventListener('load', scrollToBottom);

// Run after a short delay as additional fallback
setTimeout(scrollToBottom, 200);

// Also scroll when new messages arrive via Turbo Stream
document.addEventListener('turbo:frame-load', scrollToBottom);

// Image preview for conversation messages
document.addEventListener('DOMContentLoaded', function() {
  const photoInput = document.getElementById('conversationPhoto');
  const imagePreview = document.getElementById('conversationImagePreview');
  const previewImg = document.getElementById('conversationPreviewImg');
  const removeImage = document.getElementById('removeConversationImage');

  if (photoInput) {
    photoInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
          previewImg.src = e.target.result;
          imagePreview.classList.remove('d-none');
        };
        reader.readAsDataURL(file);
      }
    });
  }

  if (removeImage) {
    removeImage.addEventListener('click', function() {
      photoInput.value = '';
      imagePreview.classList.add('d-none');
    });
  }
});
</script>
